(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3b5de258"],{"15a6":function(e,t,s){"use strict";s("a834")},1669:function(e,t,s){"use strict";s("d4e3")},"271a":function(e,t,s){"use strict";var i=s("cb2d"),o=s("e330"),n=s("577e"),r=s("d6d6"),a=URLSearchParams,l=a.prototype,c=o(l.getAll),h=o(l.has),d=new a("a=1");!d.has("a",2)&&d.has("a",void 0)||i(l,"has",(function(e){var t=arguments.length,s=t<2?void 0:arguments[1];if(t&&void 0===s)return h(this,e);var i=c(this,e);r(t,1);var o=n(s),a=0;while(a<i.length)if(i[a++]===o)return!0;return!1}),{enumerable:!0,unsafe:!0})},2859:function(e,t,s){"use strict";var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"group-member"},[t("head-image",{attrs:{id:e.member.userId,name:e.member.showNickName,url:e.member.headImage,size:38,online:e.member.online}},[e.showDel?t("div",{staticClass:"btn-kick el-icon-error",on:{click:function(t){return t.stopPropagation(),e.onDelete()}}}):e._e()]),t("div",{staticClass:"member-name"},[e._v(e._s(e.member.showNickName))])],1)},o=[],n=s("4036"),r={name:"groupMember",components:{HeadImage:n["a"]},data(){return{}},props:{member:{type:Object,required:!0},showDel:{type:Boolean,default:!1}},methods:{onDelete(){this.$emit("del",this.member)}}},a=r,l=(s("8697"),s("2877")),c=Object(l["a"])(a,i,o,!1,null,null,null);t["a"]=c.exports},"3f51":function(e,t,s){"use strict";var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"right-menu-mask",on:{click:function(t){return t.stopPropagation(),e.close()},contextmenu:function(t){return t.preventDefault(),e.close()}}},[t("div",{staticClass:"right-menu",style:{left:e.pos.x+"px",top:e.pos.y+"px"}},[t("el-menu",{attrs:{"text-color":"#333333"}},e._l(e.items,(function(s){return t("el-menu-item",{key:s.key,attrs:{title:s.name},nativeOn:{click:function(t){return t.stopPropagation(),e.onSelectMenu(s)}}},[t("span",[e._v(e._s(s.name))])])})),1)],1)])},o=[],n={name:"rightMenu",data(){return{}},props:{pos:{type:Object},items:{type:Array}},methods:{close(){this.$emit("close")},onSelectMenu(e){this.$emit("select",e),this.close()}}},r=n,a=(s("1669"),s("2877")),l=Object(a["a"])(r,i,o,!1,null,null,null);t["a"]=l.exports},"3f94":function(e,t,s){"use strict";s.r(t);var i=function(){var e=this,t=e._self._c;return t("el-container",{staticClass:"chat-page"},[t("el-aside",{staticClass:"chat-list-box",attrs:{width:"260px"}},[t("div",{staticClass:"chat-list-header"},[t("el-input",{staticClass:"search-text",attrs:{size:"small",placeholder:"搜索"},model:{value:e.searchText,callback:function(t){e.searchText=t},expression:"searchText"}},[t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"prefix"},slot:"prefix"})])],1),e.loading?t("div",{directives:[{name:"loading",rawName:"v-loading",value:!0,expression:"true"}],staticClass:"chat-list-loading",attrs:{"element-loading-text":"消息接收中...","element-loading-spinner":"el-icon-loading","element-loading-background":"#F9F9F9","element-loading-size":"24"}}):t("el-scrollbar",{staticClass:"chat-list-items"},e._l(e.chatStore.chats,(function(s,i){return t("div",{key:i},[t("chat-item",{directives:[{name:"show",rawName:"v-show",value:!s.delete&&s.showName&&s.showName.includes(e.searchText),expression:"!chat.delete && chat.showName && chat.showName.includes(searchText)"}],attrs:{chat:s,index:i,active:s===e.chatStore.activeChat},on:{delete:function(t){return e.onDelItem(i)},top:function(t){return e.onTop(i)}},nativeOn:{click:function(t){return e.onActiveItem(i)}}})],1)})),0)],1),t("el-container",{staticClass:"chat-box"},[e.chatStore.activeChat?t("chat-box",{attrs:{chat:e.chatStore.activeChat}}):e._e()],1)],1)},o=[],n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-item",class:e.active?"active":"",on:{contextmenu:function(t){return t.preventDefault(),e.showRightMenu(t)}}},[t("div",{staticClass:"chat-left"},[t("head-image",{attrs:{url:e.chat.headImage,name:e.chat.showName,size:42,id:"PRIVATE"==e.chat.type?e.chat.targetId:0,isShowUserInfo:!1}}),t("div",{directives:[{name:"show",rawName:"v-show",value:e.chat.unreadCount>0,expression:"chat.unreadCount > 0"}],staticClass:"unread-text"},[e._v(e._s(e.chat.unreadCount))])],1),t("div",{staticClass:"chat-right"},[t("div",{staticClass:"chat-name"},[t("div",{staticClass:"chat-name-text"},[t("div",[e._v(e._s(e.chat.showName))]),"GROUP"==e.chat.type?t("el-tag",{attrs:{size:"mini",effect:"dark"}},[e._v("群")]):e._e()],1),t("div",{staticClass:"chat-time-text"},[e._v(e._s(e.showTime))])]),t("div",{staticClass:"chat-content"},[t("div",{staticClass:"chat-at-text"},[e._v(e._s(e.atText))]),t("div",{directives:[{name:"show",rawName:"v-show",value:e.isShowSendName,expression:"isShowSendName"}],staticClass:"chat-send-name"},[e._v(e._s(e.chat.sendNickName+": "))]),t("div",{staticClass:"chat-content-text",domProps:{innerHTML:e._s(e.$emo.transform(e.chat.lastContent,"emoji-small"))}})])]),t("right-menu",{directives:[{name:"show",rawName:"v-show",value:e.rightMenu.show,expression:"rightMenu.show"}],attrs:{pos:e.rightMenu.pos,items:e.rightMenu.items},on:{close:function(t){e.rightMenu.show=!1},select:e.onSelectMenu}})],1)},r=[],a=s("4036"),l=s("3f51"),c={name:"chatItem",components:{HeadImage:a["a"],RightMenu:l["a"]},data(){return{rightMenu:{show:!1,pos:{x:0,y:0},items:[{key:"TOP",name:"置顶",icon:"el-icon-top"},{key:"DELETE",name:"删除",icon:"el-icon-delete"}]}}},props:{chat:{type:Object},active:{type:Boolean},index:{type:Number}},methods:{showRightMenu(e){this.rightMenu.pos={x:e.x,y:e.y},this.rightMenu.show="true"},onSelectMenu(e){this.$emit(e.key.toLowerCase(),this.msgInfo)}},computed:{isShowSendName(){if(!this.chat.sendNickName)return!1;let e=this.chat.messages.length;if(0==e)return!1;let t=this.chat.messages[e-1];return this.$msgType.isNormal(t.type)},showTime(){return this.$date.toTimeText(this.chat.lastSendTime,!0)},atText(){return this.chat.atMe?"[有人@我]":this.chat.atAll?"[@全体成员]":""}}},h=c,d=(s("8617"),s("2877")),u=Object(d["a"])(h,n,r,!1,null,null,null),m=u.exports,p=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-box",on:{click:function(t){return e.closeRefBox()},mousemove:function(t){return e.readedMessage()}}},[t("el-container",[t("el-header",{attrs:{height:"50px"}},[t("span",[e._v(e._s(e.title))]),t("span",{directives:[{name:"show",rawName:"v-show",value:"GROUP"==this.chat.type,expression:"this.chat.type == 'GROUP'"}],staticClass:"btn-side el-icon-more",attrs:{title:"群聊信息"},on:{click:function(t){e.showSide=!e.showSide}}})]),t("el-main",{staticStyle:{padding:"0"}},[t("el-container",[t("el-container",{staticClass:"content-box"},[t("el-main",{staticClass:"im-chat-main",attrs:{id:"chatScrollBox"},on:{scroll:e.onScroll}},[t("div",{staticClass:"im-chat-box"},[t("ul",e._l(e.chat.messages,(function(s,i){return t("li",{key:i},[i>=e.showMinIdx?t("chat-message-item",{attrs:{mine:s.sendId==e.mine.id,headImage:e.headImage(s),showName:e.showName(s),msgInfo:s,groupMembers:e.groupMembers},on:{call:function(t){return e.onCall(s.type)},delete:e.deleteMessage,recall:e.recallMessage}}):e._e()],1)})),0)])]),t("el-footer",{staticClass:"im-chat-footer",attrs:{height:"220px"}},[t("div",{staticClass:"chat-tool-bar"},[t("div",{ref:"emotion",staticClass:"icon iconfont icon-emoji",attrs:{title:"表情"},on:{click:function(t){return t.stopPropagation(),e.showEmotionBox()}}}),t("div",{attrs:{title:"发送图片"}},[t("file-upload",{attrs:{action:"/image/upload",maxSize:5242880,fileTypes:["image/jpeg","image/png","image/jpg","image/webp","image/gif"]},on:{before:e.onImageBefore,success:e.onImageSuccess,fail:e.onImageFail}},[t("i",{staticClass:"el-icon-picture-outline"})])],1),t("div",{attrs:{title:"发送文件"}},[t("file-upload",{ref:"fileUpload",attrs:{action:"/file/upload",maxSize:10485760},on:{before:e.onFileBefore,success:e.onFileSuccess,fail:e.onFileFail}},[t("i",{staticClass:"el-icon-wallet"})])],1),t("div",{directives:[{name:"show",rawName:"v-show",value:"GROUP"==e.chat.type&&e.memberSize<=500,expression:"chat.type == 'GROUP' && memberSize <= 500"}],staticClass:"icon iconfont icon-receipt",class:e.isReceipt?"chat-tool-active":"",attrs:{title:"回执消息"},on:{click:e.onSwitchReceipt}}),t("div",{staticClass:"el-icon-microphone",attrs:{title:"发送语音"},on:{click:function(t){return e.showRecordBox()}}}),t("div",{staticClass:"el-icon-chat-dot-round",attrs:{title:"聊天记录"},on:{click:function(t){return e.showHistoryBox()}}})]),t("div",{staticClass:"send-content-area"},[t("ChatInput",{ref:"chatInputEditor",attrs:{ownerId:e.group.ownerId,"group-members":e.groupMembers},on:{submit:e.sendMessage}}),t("div",{staticClass:"send-btn-area"},[t("el-button",{attrs:{type:"primary",icon:"el-icon-s-promotion"},on:{click:function(t){return e.notifySend()}}},[e._v("发送")])],1)],1)])],1),e.showSide?t("el-aside",{staticClass:"chat-group-side-box",attrs:{width:"320px"}},[t("chat-group-side",{attrs:{group:e.group,groupMembers:e.groupMembers},on:{reload:function(t){return e.loadGroup(e.group.id)}}})],1):e._e()],1)],1),t("emotion",{ref:"emoBox",on:{emotion:e.onEmotion}}),t("chat-record",{attrs:{visible:e.showRecord},on:{close:e.closeRecordBox,send:e.onSendRecord}}),t("chat-history",{attrs:{visible:e.showHistory,chat:e.chat,friend:e.friend,group:e.group,groupMembers:e.groupMembers},on:{close:e.closeHistoryBox}})],1)],1)},f=[],g=(s("14d9"),s("0643"),s("2382"),s("fffc"),s("88a7"),s("271a"),s("5494"),function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-group-side"},[t("div",{directives:[{name:"show",rawName:"v-show",value:!e.group.quit,expression:"!group.quit"}],staticClass:"group-side-search"},[t("el-input",{attrs:{placeholder:"搜索群成员",size:"small"},model:{value:e.searchText,callback:function(t){e.searchText=t},expression:"searchText"}},[t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"prefix"},slot:"prefix"})])],1),t("div",{staticClass:"group-side-scrollbar"},[t("el-scrollbar",{directives:[{name:"show",rawName:"v-show",value:!e.group.quit,expression:"!group.quit"}],ref:"scrollbar",style:"height: "+e.scrollHeight+"px"},[t("div",{staticClass:"group-side-member-list"},[t("div",{staticClass:"group-side-invite"},[t("div",{staticClass:"invite-member-btn",attrs:{title:"邀请好友进群聊"},on:{click:function(t){e.showAddGroupMember=!0}}},[t("i",{staticClass:"el-icon-plus"})]),t("div",{staticClass:"invite-member-text"},[e._v("邀请")]),t("add-group-member",{attrs:{visible:e.showAddGroupMember,groupId:e.group.id,members:e.groupMembers},on:{reload:function(t){return e.$emit("reload")},close:function(t){e.showAddGroupMember=!1}}})],1),e._l(e.showMembers,(function(s,i){return t("div",{key:s.id},[i<e.showMaxIdx?t("group-member",{staticClass:"group-side-member",attrs:{member:s,showDel:!1}}):e._e()],1)}))],2)]),e.group.quit?e._e():t("el-divider",{attrs:{"content-position":"center"}}),t("el-form",{staticClass:"group-side-form",attrs:{labelPosition:"top",model:e.group,size:"small"}},[t("el-form-item",{attrs:{label:"群聊名称"}},[t("el-input",{attrs:{disabled:"",maxlength:"20"},model:{value:e.group.name,callback:function(t){e.$set(e.group,"name",t)},expression:"group.name"}})],1),t("el-form-item",{attrs:{label:"群主"}},[t("el-input",{attrs:{value:e.ownerName,disabled:""}})],1),t("el-form-item",{attrs:{label:"群公告"}},[t("el-input",{attrs:{disabled:"",type:"textarea",maxlength:"1024"},model:{value:e.group.notice,callback:function(t){e.$set(e.group,"notice",t)},expression:"group.notice"}})],1),t("el-form-item",{attrs:{label:"备注"}},[t("el-input",{attrs:{disabled:!e.editing,maxlength:"20"},model:{value:e.group.remarkGroupName,callback:function(t){e.$set(e.group,"remarkGroupName",t)},expression:"group.remarkGroupName"}})],1),t("el-form-item",{attrs:{label:"我在本群的昵称"}},[t("el-input",{attrs:{disabled:!e.editing,maxlength:"20"},model:{value:e.group.remarkNickName,callback:function(t){e.$set(e.group,"remarkNickName",t)},expression:"group.remarkNickName"}})],1),t("div",{directives:[{name:"show",rawName:"v-show",value:!e.group.quit,expression:"!group.quit"}],staticClass:"btn-group"},[e.editing?t("el-button",{attrs:{type:"success"},on:{click:function(t){return e.onSaveGroup()}}},[e._v("保存")]):e._e(),e.editing?e._e():t("el-button",{attrs:{type:"primary"},on:{click:function(t){e.editing=!e.editing}}},[e._v("编辑")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:!e.isOwner,expression:"!isOwner"}],attrs:{type:"danger"},on:{click:function(t){return e.onQuit()}}},[e._v("退出群聊")])],1)],1)],1)])}),v=[],w=s("b242"),b=s("2859"),y={name:"chatGroupSide",components:{AddGroupMember:w["a"],GroupMember:b["a"]},data(){return{searchText:"",editing:!1,showAddGroupMember:!1,showMaxIdx:50}},props:{group:{type:Object},groupMembers:{type:Array}},methods:{onClose(){this.$emit("close")},loadGroupMembers(){this.$http({url:"/group/members/"+this.group.id,method:"get"}).then(e=>{this.groupMembers=e})},onSaveGroup(){let e=this.group;this.$http({url:"/group/modify",method:"put",data:e}).then(e=>{this.editing=!this.editing,this.$store.commit("updateGroup",e),this.$emit("reload"),this.$message.success("修改成功")})},onQuit(){this.$confirm("退出群聊后将不再接受群里的消息，确认退出吗？","确认退出?",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$http({url:"/group/quit/"+this.group.id,method:"delete"}).then(()=>{this.$store.commit("removeGroup",this.group.id),this.$store.commit("removeGroupChat",this.group.id)})})},onScroll(e){const t=e.target;t.scrollTop+t.clientHeight>=t.scrollHeight-30&&this.showMaxIdx<this.showMembers.length&&(this.showMaxIdx+=30)}},computed:{ownerName(){let e=this.groupMembers.find(e=>e.userId==this.group.ownerId);return e&&e.showNickName},isOwner(){return this.group.ownerId==this.$store.state.userStore.userInfo.id},showMembers(){return this.groupMembers.filter(e=>!e.quit&&e.showNickName.includes(this.searchText))},scrollHeight(){return Math.min(400,80+this.showMembers.length/5*80)}},mounted(){let e=this.$refs.scrollbar.$el.querySelector(".el-scrollbar__wrap");e.addEventListener("scroll",this.onScroll)}},x=y,I=(s("bfba"),Object(d["a"])(x,g,v,!1,null,null,null)),C=I.exports,S=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-msg-item"},[e.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TEXT?t("div",{staticClass:"chat-msg-tip"},[e._v(" "+e._s(e.msgInfo.content)+" ")]):e.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TIME?t("div",{staticClass:"chat-msg-tip"},[e._v(" "+e._s(e.$date.toTimeText(e.msgInfo.sendTime))+" ")]):e.isNormal?t("div",{staticClass:"chat-msg-normal",class:{"chat-msg-mine":e.mine}},[t("div",{staticClass:"head-image"},[t("head-image",{attrs:{name:e.showName,size:38,url:e.headImage,id:e.msgInfo.sendId}})],1),t("div",{staticClass:"chat-msg-content"},[t("div",{directives:[{name:"show",rawName:"v-show",value:1==e.mode&&e.msgInfo.groupId&&!e.msgInfo.selfSend,expression:"mode == 1 && msgInfo.groupId && !msgInfo.selfSend"}],staticClass:"chat-msg-top"},[t("span",[e._v(e._s(e.showName))])]),t("div",{directives:[{name:"show",rawName:"v-show",value:2==e.mode,expression:"mode == 2"}],staticClass:"chat-msg-top"},[t("span",[e._v(e._s(e.showName))]),t("span",[e._v(e._s(e.$date.toTimeText(e.msgInfo.sendTime)))])]),t("div",{staticClass:"chat-msg-bottom",on:{contextmenu:function(t){return t.preventDefault(),e.showRightMenu(t)}}},[t("div",{ref:"chatMsgBox"},[e.msgInfo.type==e.$enums.MESSAGE_TYPE.TEXT||e.msgInfo.type==e.$enums.MESSAGE_TYPE.SENTEXT?t("span",{staticClass:"chat-msg-text",domProps:{innerHTML:e._s(e.htmlText)}}):e._e(),e.msgInfo.type==e.$enums.MESSAGE_TYPE.IMAGE?t("div",{staticClass:"chat-msg-image"},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"img-load-box",attrs:{"element-loading-text":"上传中..","element-loading-background":"rgba(0, 0, 0, 0.4)"}},[t("img",{staticClass:"send-image",attrs:{src:JSON.parse(e.msgInfo.content).thumbUrl,loading:"lazy"},on:{click:function(t){return e.showFullImageBox()}}})]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.loadFail,expression:"loadFail"}],staticClass:"send-fail el-icon-warning",attrs:{title:"发送失败"},on:{click:e.onSendFail}})]):e._e(),e.msgInfo.type==e.$enums.MESSAGE_TYPE.FILE?t("div",{staticClass:"chat-msg-file"},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"chat-file-box"},[t("div",{staticClass:"chat-file-info"},[t("el-link",{staticClass:"chat-file-name",attrs:{underline:!0,target:"_blank",type:"primary",href:e.data.url,download:e.data.name}},[e._v(e._s(e.data.name))]),t("div",{staticClass:"chat-file-size"},[e._v(e._s(e.fileSize))])],1),e._m(0)]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.loadFail,expression:"loadFail"}],staticClass:"send-fail el-icon-warning",attrs:{title:"发送失败"},on:{click:e.onSendFail}})]):e._e()]),e.msgInfo.type==e.$enums.MESSAGE_TYPE.AUDIO?t("div",{staticClass:"chat-msg-voice",on:{click:function(t){return e.onPlayVoice()}}},[t("audio",{attrs:{controls:"",src:JSON.parse(e.msgInfo.content).url}})]):e._e(),e.isAction?t("div",{staticClass:"chat-action chat-msg-text"},[e.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VOICE?t("span",{staticClass:"iconfont icon-chat-voice",attrs:{title:"重新呼叫"},on:{click:function(t){return e.$emit("call")}}}):e._e(),e.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VIDEO?t("span",{staticClass:"iconfont icon-chat-video",attrs:{title:"重新呼叫"},on:{click:function(t){return e.$emit("call")}}}):e._e(),t("span",[e._v(e._s(e.msgInfo.content))])]):e._e(),e.isAction?e._e():t("div",{staticClass:"chat-msg-status"},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.msgInfo.selfSend&&!e.msgInfo.groupId&&e.msgInfo.status==e.$enums.MESSAGE_STATUS.READED,expression:"msgInfo.selfSend && !msgInfo.groupId\n\t\t\t\t\t\t&& msgInfo.status == $enums.MESSAGE_STATUS.READED"}],staticClass:"chat-readed"},[e._v("已读")]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.msgInfo.selfSend&&!e.msgInfo.groupId&&e.msgInfo.status!=e.$enums.MESSAGE_STATUS.READED,expression:"msgInfo.selfSend && !msgInfo.groupId\n\t\t\t\t\t\t&& msgInfo.status != $enums.MESSAGE_STATUS.READED"}],staticClass:"chat-unread"},[e._v("未读")])]),t("div",{directives:[{name:"show",rawName:"v-show",value:e.msgInfo.receipt,expression:"msgInfo.receipt"}],staticClass:"chat-receipt",on:{click:e.onShowReadedBox}},[e.msgInfo.receiptOk?t("span",{staticClass:"icon iconfont icon-ok",attrs:{title:"全体已读"}}):t("span",[e._v(e._s(e.msgInfo.readedCount)+"人已读")])])])])]):e._e(),t("right-menu",{directives:[{name:"show",rawName:"v-show",value:e.menu&&e.rightMenu.show,expression:"menu && rightMenu.show"}],attrs:{pos:e.rightMenu.pos,items:e.menuItems},on:{close:function(t){e.rightMenu.show=!1},select:e.onSelectMenu}}),t("chat-group-readed",{ref:"chatGroupReadedBox",attrs:{msgInfo:e.msgInfo,groupMembers:e.groupMembers}})],1)},M=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-file-icon"},[t("span",{staticClass:"el-icon-document",attrs:{type:"primary"}})])}],T=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"show",rawName:"v-show",value:e.show,expression:"show"}]},[t("div",{staticClass:"chat-group-readed-mask",on:{click:function(t){return t.target!==t.currentTarget?null:e.close()}}},[t("div",{staticClass:"chat-group-readed",style:{left:e.pos.x+"px",top:e.pos.y+"px"},on:{click:function(e){e.preventDefault()}}},[t("el-tabs",{attrs:{type:"border-card",stretch:!0}},[t("el-tab-pane",{attrs:{label:`已读(${e.readedMembers.length})`}},[t("virtual-scroller",{staticClass:"scroll-box",attrs:{items:e.readedMembers},scopedSlots:e._u([{key:"default",fn:function({item:e}){return[t("chat-group-member",{attrs:{member:e}})]}}])})],1),t("el-tab-pane",{attrs:{label:`未读(${e.unreadMembers.length})`}},[t("virtual-scroller",{staticClass:"scroll-box",attrs:{items:e.unreadMembers},scopedSlots:e._u([{key:"default",fn:function({item:e}){return[t("chat-group-member",{attrs:{member:e}})]}}])})],1)],1),t("div",{directives:[{name:"show",rawName:"v-show",value:e.msgInfo.selfSend,expression:"msgInfo.selfSend"}],staticClass:"arrow-right",style:{top:e.pos.arrowY+"px"}},[t("div",{staticClass:"arrow-right-inner"})]),t("div",{directives:[{name:"show",rawName:"v-show",value:!e.msgInfo.selfSend,expression:"!msgInfo.selfSend"}],staticClass:"arrow-left",style:{top:e.pos.arrowY+"px"}},[t("div",{staticClass:"arrow-left-inner"})])],1)])])},_=[],N=(s("4e3e"),function(){var e=this,t=e._self._c;return t("el-scrollbar",{ref:"scrollbar"},e._l(e.items,(function(s,i){return t("div",{key:i},[i<e.showMaxIdx?e._t("default",null,{item:s}):e._e()],2)})),0)}),k=[],E={name:"virtualScroller",data(){return{page:1,isInitEvent:!1,lockTip:!1}},props:{items:{type:Array},size:{type:Number,default:30}},methods:{init(){this.page=1,this.initEvent()},initEvent(){if(!this.isInitEvent){let e=this.$refs.scrollbar.$el.querySelector(".el-scrollbar__wrap");e.addEventListener("scroll",this.onScroll),this.isInitEvent=!0}},onScroll(e){const t=e.target;t.scrollTop+t.clientHeight>=t.scrollHeight-30&&(this.showMaxIdx>=this.items.length?this.showTip():this.page++)},showTip(){this.lockTip||(this.$message.success("已到滚动到底部"),this.lockTip=!0,setTimeout(()=>{this.lockTip=!1},3e3))}},computed:{showMaxIdx(){return Math.min(this.page*this.size,this.items.length)}},mounted(){this.initEvent()}},R=E,$=Object(d["a"])(R,N,k,!1,null,"821ed2d2",null),A=$.exports,P=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-group-member",class:e.active?"active":"",style:{height:e.height+"px"}},[t("div",{staticClass:"member-avatar"},[t("head-image",{attrs:{size:e.headImageSize,name:e.member.showNickName,url:e.member.headImage}})],1),t("div",{staticClass:"member-name",style:{"line-height":e.height+"px"}},[t("div",[e._v(e._s(e.member.showNickName))])])])},B=[],O={name:"groupMember",components:{HeadImage:a["a"]},data(){return{}},props:{member:{type:Object,required:!0},height:{type:Number,default:50},active:{type:Boolean,default:!1}},computed:{headImageSize(){return Math.ceil(.75*this.height)}}},U=O,G=(s("da12"),Object(d["a"])(U,P,B,!1,null,null,null)),D=G.exports,L={name:"chatGroupReaded",components:{ChatGroupMember:D,VirtualScroller:A},data(){return{show:!1,pos:{x:0,y:0,arrowY:0},readedMembers:[],unreadMembers:[]}},props:{groupMembers:{type:Array},msgInfo:{type:Object}},methods:{close(){this.show=!1},open(e){this.show=!0,this.pos.arrowY=200,this.msgInfo.selfSend?this.pos.x=e.left-310:this.pos.x=e.right+20,this.pos.y=e.top+e.height/2-215,this.pos.y<0&&(this.pos.arrowY+=this.pos.y,this.pos.y=0),this.loadReadedUser()},loadReadedUser(){this.readedMembers=[],this.unreadMembers=[],this.$http({url:"/message/group/findReadedUsers",method:"get",params:{groupId:this.msgInfo.groupId,messageId:this.msgInfo.id}}).then(e=>{this.groupMembers.forEach(t=>{t.userId==this.msgInfo.sendId||t.quit||(e.find(e=>t.userId==e)?this.readedMembers.push(t):this.unreadMembers.push(t))});let t={id:this.msgInfo.id,groupId:this.msgInfo.groupId,readedCount:this.readedMembers.length},s={type:"GROUP",targetId:this.msgInfo.groupId};this.$store.commit("updateMessage",[t,s])})}}},F=L,j=(s("dee0"),Object(d["a"])(F,T,_,!1,null,null,null)),z=j.exports,H={name:"messageItem",components:{HeadImage:a["a"],RightMenu:l["a"],ChatGroupReaded:z},props:{mode:{type:Number,default:1},mine:{type:Boolean,required:!0},headImage:{type:String,required:!0},showName:{type:String,required:!0},msgInfo:{type:Object,required:!0},groupMembers:{type:Array},menu:{type:Boolean,default:!0}},data(){return{audioPlayState:"STOP",rightMenu:{show:!1,pos:{x:0,y:0}}}},methods:{onSendFail(){this.$message.error("该文件已发送失败，目前不支持自动重新发送，建议手动重新发送")},showFullImageBox(){let e=JSON.parse(this.msgInfo.content).originUrl;e&&this.$store.commit("showFullImageBox",e)},onPlayVoice(){this.audio||(this.audio=new Audio),this.audio.src=JSON.parse(this.msgInfo.content).url,this.audio.play(),this.onPlayVoice="RUNNING"},showRightMenu(e){this.rightMenu.pos={x:e.x,y:e.y},this.rightMenu.show="true"},onSelectMenu(e){this.$emit(e.key.toLowerCase(),this.msgInfo)},onShowReadedBox(){let e=this.$refs.chatMsgBox.getBoundingClientRect();this.$refs.chatGroupReadedBox.open(e)}},computed:{loading(){return this.msgInfo.loadStatus&&"loading"===this.msgInfo.loadStatus},loadFail(){return this.msgInfo.loadStatus&&"fail"===this.msgInfo.loadStatus},data(){return JSON.parse(this.msgInfo.content)},fileSize(){let e=this.data.size;return e>1048576?Math.round(e/1024/1024)+"M":e>1024?Math.round(e/1024)+"KB":e+"B"},menuItems(){let e=[];return e.push({key:"DELETE",name:"删除",icon:"el-icon-delete"}),this.msgInfo.selfSend&&this.msgInfo.id>0&&e.push({key:"RECALL",name:"撤回",icon:"el-icon-refresh-left"}),e},isAction(){return this.$msgType.isAction(this.msgInfo.type)},isNormal(){const e=this.msgInfo.type;return this.$msgType.isNormal(e)||this.$msgType.isAction(e)},htmlText(){let e=this.msgInfo.selfSend?"white":"",t=this.$url.replaceURLWithHTMLLinks(this.msgInfo.content,e);return this.$emo.transform(t,"emoji-normal")}}},q=H,V=(s("7baa"),Object(d["a"])(q,S,M,!1,null,null,null)),J=V.exports,Y=s("1a05"),W=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"show",rawName:"v-show",value:e.show,expression:"show"}],on:{click:function(t){return e.close()}}},[t("div",{staticClass:"emotion-box",style:{left:e.x+"px",top:e.y+"px"}},[t("el-scrollbar",{staticStyle:{height:"220px"}},[t("div",{staticClass:"emotion-item-list"},e._l(e.$emo.emoTextList,(function(s,i){return t("div",{key:i,staticClass:"emotion-item",domProps:{innerHTML:e._s(e.$emo.textToImg(s,"emoji-large"))},on:{click:function(t){return e.onClickEmo(s)}}})})),0)])],1)])},Q=[],K={name:"emotion",data(){return{show:!1,pos:{x:0,y:0}}},methods:{onClickEmo(e){let t=`#${e};`;this.$emit("emotion",t)},open(e){this.pos=e,this.show=!0},close(){this.show=!1}},computed:{x(){return this.pos.x-22},y(){return this.pos.y-234}}},X=K,Z=(s("8822"),Object(d["a"])(X,W,Q,!1,null,"0592fba6",null)),ee=Z.exports,te=function(){var e=this,t=e._self._c;return t("el-dialog",{staticClass:"chat-record",attrs:{title:"语音录制",visible:e.visible,width:"600px","before-close":e.onClose},on:{"update:visible":function(t){e.visible=t}}},[t("div",{directives:[{name:"show",rawName:"v-show",value:"RECORD"==e.mode,expression:"mode == 'RECORD'"}]},[t("div",{staticClass:"tip"},[e._v(e._s(e.stateTip))]),t("div",[e._v("时长: "+e._s("STOP"==e.state?0:parseInt(e.rc.duration))+"s")])]),t("audio",{directives:[{name:"show",rawName:"v-show",value:"PLAY"==e.mode,expression:"mode == 'PLAY'"}],ref:"audio",attrs:{src:e.url,controls:""},on:{ended:function(t){return e.onStopAudio()}}}),t("el-divider",{attrs:{"content-position":"center"}}),t("el-row",{staticClass:"btn-group"},[t("el-button",{directives:[{name:"show",rawName:"v-show",value:"STOP"==e.state,expression:"state == 'STOP'"}],attrs:{round:"",type:"primary"},on:{click:function(t){return e.onStartRecord()}}},[e._v("开始录音")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"RUNNING"==e.state,expression:"state == 'RUNNING'"}],attrs:{round:"",type:"warning"},on:{click:function(t){return e.onPauseRecord()}}},[e._v("暂停录音")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"PAUSE"==e.state,expression:"state == 'PAUSE'"}],attrs:{round:"",type:"primary"},on:{click:function(t){return e.onResumeRecord()}}},[e._v("继续录音")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"RUNNING"==e.state||"PAUSE"==e.state,expression:"state == 'RUNNING' || state == 'PAUSE'"}],attrs:{round:"",type:"danger"},on:{click:function(t){return e.onCompleteRecord()}}},[e._v(" 结束录音")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"COMPLETE"==e.state&&"PLAY"!=e.mode,expression:"state == 'COMPLETE' && mode != 'PLAY'"}],attrs:{round:"",type:"success"},on:{click:function(t){return e.onPlayAudio()}}},[e._v("播放录音 ")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"COMPLETE"==e.state&&"PLAY"==e.mode,expression:"state == 'COMPLETE' && mode == 'PLAY'"}],attrs:{round:"",type:"warning"},on:{click:function(t){return e.onStopAudio()}}},[e._v("停止播放 ")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"COMPLETE"==e.state,expression:"state == 'COMPLETE'"}],attrs:{round:"",type:"primary"},on:{click:function(t){return e.onRestartRecord()}}},[e._v("重新录音")]),t("el-button",{directives:[{name:"show",rawName:"v-show",value:"COMPLETE"==e.state,expression:"state == 'COMPLETE'"}],attrs:{round:"",type:"primary"},on:{click:function(t){return e.onSendRecord()}}},[e._v("立即发送")])],1)],1)},se=[],ie=s("da43"),oe=s.n(ie),ne={name:"chatRecord",props:{visible:{type:Boolean}},data(){return{rc:new oe.a,audio:new Audio,state:"STOP",stateTip:"未开始",mode:"RECORD",duration:0,url:""}},methods:{onClose(){this.rc.destroy(),this.rc=new oe.a,this.audio.pause(),this.mode="RECORD",this.state="STOP",this.stateTip="未开始",this.$emit("close")},onStartRecord(){this.rc.start().then(e=>{this.state="RUNNING",this.stateTip="正在录音..."}).catch(e=>{this.$message.error(e)})},onPauseRecord(){this.rc.pause(),this.state="PAUSE",this.stateTip="已暂停录音"},onResumeRecord(){this.rc.resume(),this.state="RUNNING",this.stateTip="正在录音..."},onCompleteRecord(){this.rc.pause(),this.state="COMPLETE",this.stateTip="已结束录音"},onPlayAudio(){let e=this.rc.getWAVBlob(),t=URL.createObjectURL(e);this.$refs.audio.src=t,this.$refs.audio.play(),this.mode="PLAY"},onStopAudio(){this.$refs.audio.pause(),this.mode="RECORD"},onRestartRecord(){this.rc.destroy(),this.rc=new oe.a,this.rc.start(),this.state="RUNNING",this.mode="RECORD",this.stateTip="正在录音..."},onSendRecord(){let e=this.rc.getWAVBlob(),t=(new Date).getDate()+".wav";var s=new window.FormData;s.append("file",e,t),this.$http({url:"/file/upload",data:s,method:"post",headers:{"Content-Type":"multipart/form-data"}}).then(e=>{let t={duration:parseInt(this.rc.duration),url:e};this.$emit("send",t),this.onClose()})}}},re=ne,ae=(s("5b4c"),Object(d["a"])(re,te,se,!1,null,null,null)),le=ae.exports,ce=function(){var e=this,t=e._self._c;return t("el-drawer",{attrs:{title:"聊天历史记录",size:"700px",visible:e.visible,direction:"rtl","before-close":e.onClose},on:{"update:visible":function(t){e.visible=t}}},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"chat-history",attrs:{"element-loading-text":"拼命加载中"}},[t("el-scrollbar",{ref:"scrollbar",staticClass:"chat-history-scrollbar",attrs:{id:"historyScrollbar"}},[t("ul",e._l(e.messages,(function(s,i){return t("li",{key:i},[t("chat-message-item",{attrs:{mode:2,mine:s.sendId==e.mine.id,headImage:e.headImage(s),showName:e.showName(s),msgInfo:s,menu:!1}})],1)})),0)])],1)])},he=[],de={name:"chatHistory",components:{ChatMessageItem:J},props:{visible:{type:Boolean},chat:{type:Object},friend:{type:Object},group:{type:Object},groupMembers:{type:Array}},data(){return{page:1,size:10,messages:[],loadAll:!1,loading:!1,lastScrollTime:new Date}},methods:{onClose(){this.page=1,this.messages=[],this.loadAll=!1,this.$emit("close")},onScroll(){let e=this.$refs.scrollbar.$refs.wrap.scrollTop,t=(new Date).getTime()-this.lastScrollTime.getTime();e<30&&t>500&&(this.lastScrollTime=new Date,this.loadMessages())},loadMessages(){if(this.loadAll)return this.$message.success("已到达顶部");let e={page:this.page++,size:this.size};"GROUP"==this.chat.type?e.groupId=this.group.id:e.friendId=this.friend.id,this.loading=!0,this.$http({url:this.histroyAction,method:"get",params:e}).then(e=>{e.forEach(e=>this.messages.unshift(e)),this.loading=!1,e.length<this.size&&(this.loadAll=!0),this.refreshScrollPos()}).catch(()=>{this.loading=!1})},showName(e){if("GROUP"==this.chat.type){let t=this.groupMembers.find(t=>t.userId==e.sendId);return t?t.showNickName:""}return e.sendId==this.mine.id?this.mine.nickName:this.chat.showName},headImage(e){if("GROUP"==this.chat.type){let t=this.groupMembers.find(t=>t.userId==e.sendId);return t?t.headImage:""}return e.sendId==this.mine.id?this.mine.headImageThumb:this.chat.headImage},refreshScrollPos(){let e=this.$refs.scrollbar.$refs.wrap,t=e.scrollHeight,s=e.scrollTop;this.$nextTick(()=>{let i=e.scrollHeight-t;e.scrollTop=s+i,e.scrollHeight==t&&this.loadMessages()})}},computed:{mine(){return this.$store.state.userStore.userInfo},histroyAction(){return`/message/${this.chat.type.toLowerCase()}/history`}},watch:{visible:{handler(e,t){e&&(this.loadMessages(),this.$nextTick(()=>{document.getElementById("historyScrollbar").addEventListener("mousewheel",this.onScroll,!0)}))}}}},ue=de,me=(s("15a6"),Object(d["a"])(ue,ce,he,!1,null,null,null)),pe=me.exports,fe=function(){var e=this,t=e._self._c;return t("el-scrollbar",{directives:[{name:"show",rawName:"v-show",value:e.show&&e.showMembers.length,expression:"show && showMembers.length"}],ref:"scrollBox",staticClass:"group-member-choose",style:{left:e.pos.x+"px",top:e.pos.y-300+"px"}},e._l(e.showMembers,(function(s,i){return t("div",{key:s.id},[t("chat-group-member",{attrs:{member:s,height:40,active:e.activeIdx==i},nativeOn:{click:function(t){return e.onSelectMember(s)}}})],1)})),0)},ge=[],ve={name:"chatAtBox",components:{ChatGroupMember:D},props:{searchText:{type:String,default:""},ownerId:{type:Number},members:{type:Array}},data(){return{show:!1,pos:{x:0,y:0},activeIdx:0,showMembers:[]}},methods:{init(){this.$refs.scrollBox.wrap.scrollTop=0,this.showMembers=[];let e=this.$store.state.userStore.userInfo.id,t="全体成员";this.ownerId==e&&t.startsWith(this.searchText)&&this.showMembers.push({userId:-1,showNickName:t}),this.members.forEach(t=>{this.showMembers.length>100||t.userId!=e&&!t.quit&&t.showNickName.startsWith(this.searchText)&&this.showMembers.push(t)}),this.activeIdx=this.showMembers.length>0?0:-1},open(e){this.show=!0,this.pos=e,this.init()},close(){this.show=!1},moveUp(){this.activeIdx>0&&(this.activeIdx--,this.scrollToActive())},moveDown(){this.activeIdx<this.showMembers.length-1&&(this.activeIdx++,this.scrollToActive())},select(){this.activeIdx>=0&&this.onSelectMember(this.showMembers[this.activeIdx]),this.close()},scrollToActive(){35*this.activeIdx-this.$refs.scrollBox.wrap.clientHeight>this.$refs.scrollBox.wrap.scrollTop&&(this.$refs.scrollBox.wrap.scrollTop+=140,this.$refs.scrollBox.wrap.scrollTop>this.$refs.scrollBox.wrap.scrollHeight&&(this.$refs.scrollBox.wrap.scrollTop=this.$refs.scrollBox.wrap.scrollHeight)),35*this.activeIdx<this.$refs.scrollBox.wrap.scrollTop&&(this.$refs.scrollBox.wrap.scrollTop-=140,this.$refs.scrollBox.wrap.scrollTop<0&&(this.$refs.scrollBox.wrap.scrollTop=0))},onSelectMember(e){this.$emit("select",e),this.show=!1}},computed:{isOwner(){return this.$store.state.userStore.userInfo.id==this.ownerId}},watch:{searchText:{handler(e,t){this.init()}}}},we=ve,be=(s("aa5b"),Object(d["a"])(we,fe,ge,!1,null,"3e4833d6",null)),ye=be.exports,xe=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{title:"选择成员",visible:e.isShow,width:"700px"},on:{"update:visible":function(t){e.isShow=t}}},[t("div",{staticClass:"group-member-selector"},[t("div",{staticClass:"left-box"},[t("el-input",{attrs:{placeholder:"搜索"},model:{value:e.searchText,callback:function(t){e.searchText=t},expression:"searchText"}},[t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"suffix"},slot:"suffix"})]),t("virtual-scroller",{staticClass:"scroll-box",attrs:{items:e.showMembers},scopedSlots:e._u([{key:"default",fn:function({item:s}){return[t("group-member-item",{attrs:{member:s},nativeOn:{click:function(t){return e.onClickMember(s)}}},[t("el-checkbox",{attrs:{disabled:s.locked},on:{change:function(t){return e.onChange(s)}},nativeOn:{click:function(e){e.stopPropagation()}},model:{value:s.checked,callback:function(t){e.$set(s,"checked",t)},expression:"item.checked"}})],1)]}}])})],1),t("div",{staticClass:"arrow el-icon-d-arrow-right"}),t("div",{staticClass:"right-box"},[t("div",{staticClass:"select-tip"},[e._v(" 已勾选"+e._s(e.checkedMembers.length)+"位成员")]),t("div",{staticClass:"checked-member-list"},e._l(e.members,(function(s){return t("div",{key:s.userId},[s.checked?t("group-member",{staticClass:"member-item",attrs:{member:s}}):e._e()],1)})),0)])]),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){return e.close()}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.ok()}}},[e._v("确 定")])],1)])},Ie=[],Ce=function(){var e=this,t=e._self._c;return t("div",{staticClass:"group-member-item",style:{height:e.height+"px"}},[t("div",{staticClass:"member-avatar"},[t("head-image",{attrs:{size:e.headImageSize,name:e.member.showNickName,url:e.member.headImage,online:e.member.online}})],1),t("div",{staticClass:"member-name",style:{"line-height":e.height+"px"}},[t("div",[e._v(e._s(e.member.showNickName))])]),e._t("default")],2)},Se=[],Me={name:"groupMember",components:{HeadImage:a["a"]},data(){return{}},props:{member:{type:Object,required:!0},height:{type:Number,default:50}},computed:{headImageSize(){return Math.ceil(.75*this.height)}}},Te=Me,_e=(s("878a"),Object(d["a"])(Te,Ce,Se,!1,null,null,null)),Ne=_e.exports,ke={name:"addGroupMember",components:{GroupMemberItem:Ne,GroupMember:b["a"],VirtualScroller:A},data(){return{isShow:!1,searchText:"",maxSize:-1,members:[]}},props:{groupId:{type:Number}},methods:{open(e,t,s){this.maxSize=e,this.isShow=!0,this.loadGroupMembers(t,s)},loadGroupMembers(e,t){this.$http({url:"/group/members/"+this.groupId,method:"get"}).then(s=>{s.forEach(s=>{s.checked=e.indexOf(s.userId)>=0,s.locked=t.indexOf(s.userId)>=0}),this.members=s})},onClickMember(e){e.locked||(e.checked=!e.checked),this.checkedMembers.length>this.maxSize&&(this.$message.error(`最多选择${this.maxSize}位成员`),e.checked=!1)},onChange(e){this.checkedMembers.length>this.maxSize&&(this.$message.error(`最多选择${this.maxSize}位成员`),e.checked=!1)},ok(){this.$emit("complete",this.checkedMembers),this.isShow=!1},close(){this.isShow=!1}},computed:{checkedMembers(){let e=[];return this.members.forEach(t=>{t.checked&&e.push(t)}),e},showMembers(){return this.members.filter(e=>!e.hide&&!e.quit&&e.showNickName.includes(this.searchText))}}},Ee=ke,Re=(s("a9d3"),Object(d["a"])(Ee,xe,Ie,!1,null,null,null)),$e=Re.exports,Ae=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-input-area"},[t("div",{ref:"content",class:["edit-chat-container",e.isEmpty?"":"not-empty"],attrs:{contenteditable:"true"},on:{paste:function(t){return t.preventDefault(),e.onPaste.apply(null,arguments)},keydown:e.onKeydown,compositionstart:function(t){e.compositionFlag=!0},compositionend:e.onCompositionEnd,input:e.onEditorInput,mousedown:e.onMousedown,blur:e.onBlur}}),t("chat-at-box",{ref:"atBox",attrs:{"search-text":e.atSearchText,ownerId:e.ownerId,members:e.groupMembers},on:{select:e.onAtSelect}})],1)},Pe=[],Be={name:"ChatInput",components:{ChatAtBox:ye},props:{ownerId:{type:Number},groupMembers:{type:Array}},data(){return{imageList:[],fileList:[],currentId:0,atSearchText:null,compositionFlag:!1,atIng:!1,isEmpty:!0,changeStored:!0,blurRange:null}},methods:{onPaste(e){this.isEmpty=!1;let t=e.clipboardData.getData("Text"),s=window.getSelection().getRangeAt(0);if(s.startContainer===s.endContainer&&s.startOffset===s.endOffset||s.deleteContents(),t&&"string"==typeof t){let e=document.createTextNode(t);return s.insertNode(e),void s.collapse()}let i=(e.clipboardData||window.clipboardData).items;if(i.length)for(let o=0;o<i.length;o++)if(-1!==i[o].type.indexOf("image")){let e=i[o].getAsFile(),t={fileId:this.generateId(),file:e,url:URL.createObjectURL(e)};this.imageList[t.fileId]=t;let s=this.newLine(),n=document.createElement("img");n.className="chat-image no-text",n.src=t.url,n.dataset.imgId=t.fileId,s.appendChild(n);let r=document.createTextNode(" ");s.appendChild(r),this.selectElement(r,1)}else{let e=i[o].getAsFile();if(!e)continue;let t={fileId:this.generateId(),file:e};this.fileList[t.fileId]=t;let s=this.newLine(),n=this.createFile(t);s.appendChild(n);let r=document.createTextNode(" ");s.appendChild(r),this.selectElement(r,1)}s.collapse()},selectElement(e,t){let s=window.getSelection();this.$nextTick(()=>{let i=document.createRange();i.setStart(e,0),i.setEnd(e,t||0),e.firstChild&&i.selectNodeContents(e.firstChild),i.collapse(),s.removeAllRanges(),s.addRange(i),e.focus&&e.focus()})},onCompositionEnd(e){this.compositionFlag=!1,this.onEditorInput(e)},onKeydown(e){if(13!==e.keyCode)8===e.keyCode&&(console.log("delete"),setTimeout(()=>{let e=this.$refs.content.innerHTML.trim();console.log(e),""===e||"<br>"===e||"<div>&nbsp;</div>"===e?(this.empty(),this.isEmpty=!0,this.selectElement(this.$refs.content)):this.isEmpty=!1})),this.atIng&&(38===e.keyCode&&(e.preventDefault(),e.stopPropagation(),this.$refs.atBox.moveUp()),40===e.keyCode&&(e.preventDefault(),e.stopPropagation(),this.$refs.atBox.moveDown()));else{if(e.preventDefault(),e.stopPropagation(),this.atIng)return console.log("选中at的人"),void this.$refs.atBox.select();if(e.ctrlKey){let e=this.newLine(),t=document.createTextNode(" ");e.appendChild(t),this.selectElement(e.childNodes[0],0)}else{if(this.compositionFlag)return;this.submit()}}},onAtSelect(e){this.atIng=!1;let t=this.blurRange,s=t.endContainer,i=s.data.indexOf("@"+this.atSearchText),o=i+this.atSearchText.length+1;t.setStart(t.endContainer,i),t.setEnd(t.endContainer,o),t.deleteContents(),t.collapse(),console.log("onAtSelect"),this.focus();let n=document.createElement("SPAN");n.className="chat-at-user",n.dataset.id=e.userId,n.contentEditable="false",n.innerText="@"+e.showNickName,t.insertNode(n),t.collapse();let r=document.createTextNode(" ");t.insertNode(r),t.collapse(),this.atSearchText="",this.selectElement(r,1)},onEditorInput(e){if(this.isEmpty=!1,this.changeStored=!1,this.$props.groupMembers&&!this.compositionFlag){let t=window.getSelection(),s=t.getRangeAt(0),i=s.endContainer,o=s.endOffset,n=i.textContent,r=-1;for(let e=o;e>=0;e--)if("@"===n[e]){r=e;break}if(-1===r)return void this.$refs.atBox.close();let a=o;for(let e=o;e<n.length;e++)if(" "===n[e]){a=e;break}this.atSearchText=n.substring(r+1,a).trim(),""==this.atSearchText&&this.showAtBox(e)}},onBlur(e){this.updateRange()},onMousedown(){this.atIng&&(this.$refs.atBox.close(),this.atIng=!1)},insertEmoji(e){let t=document.createElement("img");t.className="emoji-normal no-text",t.dataset.emojiCode=e,t.src=this.$emo.textToUrl(e);let s=this.blurRange;s||(this.focus(),this.updateRange(),s=this.blurRange),s.startContainer===s.endContainer&&s.startOffset===s.endOffset||s.deleteContents(),s.insertNode(t),s.collapse();let i=document.createTextNode(" ");s.insertNode(i),s.collapse(),this.selectElement(i),this.updateRange(),this.isEmpty=!1},generateId(){return this.currentId++},createFile(e){let t=e.file,s=e.fileId,i=document.createElement("div");i.className="chat-file-container no-text",i.contentEditable="false",i.dataset.fileId=s;let o=document.createElement("div");o.className="file-position-left",i.appendChild(o);let n=document.createElement("div");n.className="el-icon-document",o.appendChild(n);let r=document.createElement("div");r.className="file-position-right",i.appendChild(r);let a=document.createElement("div");a.className="file-name",a.innerText=t.name;let l=document.createElement("div");return l.className="file-size",l.innerText=this.sizeConvert(t.size),r.appendChild(a),r.appendChild(l),i},sizeConvert(e){return e<1024?e+"B":e<1048576?(e/1024).toFixed(2)+"KB":e<1073741824?(e/1024/1024).toFixed(2)+"MB":(e/1024/1024/1024).toFixed(2)+"GB"},updateRange(){let e=window.getSelection();this.blurRange=e.getRangeAt(0)},newLine(){let e=window.getSelection(),t=e.getRangeAt(0),s=document.createElement("div"),i=t.endContainer,o=i.parentElement;return o.parentElement===this.$refs.content?(s.innerHTML=i.textContent.substring(t.endOffset).trim(),i.textContent=i.textContent.substring(0,t.endOffset),o.insertAdjacentElement("afterend",s)):(s.innerHTML="",this.$refs.content.append(s)),s},clear(){this.empty(),this.imageList=[],this.fileList=[]},empty(){this.$refs.content.innerHTML="";let e=this.newLine(),t=document.createTextNode(" ");e.appendChild(t),this.$nextTick(()=>this.selectElement(t))},showAtBox(e){this.atIng=!0;let t=window.getSelection(),s=t.getRangeAt(0),i=s.getBoundingClientRect();this.$refs.atBox.open({x:i.x,y:i.y}),this.updateRange()},html2Escape(e){return e.replace(/[<>&"]/g,(function(e){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e]}))},submit(){let e=this.$refs.content.childNodes,t=[],s="",i=[],o=e=>{for(let n=0;n<e.length;n++){let r=e[n];if(!r)continue;if(3===r.nodeType){s+=this.html2Escape(r.textContent);continue}let a=r.nodeName.toLowerCase();if("script"===a)continue;let l=s.trim();if("img"===a){let e=r.dataset.imgId;if(e)l&&(t.push({type:"text",content:l,atUserIds:i}),s="",i=[]),t.push({type:"image",content:this.imageList[e]});else{let e=r.dataset.emojiCode;s+=e}}else if("div"===a){let e=r.dataset.fileId;e?(l&&(t.push({type:"text",content:l,atUserIds:i}),s="",i=[]),t.push({type:"file",content:this.fileList[e]})):(s+="\n",o(r.childNodes))}else"span"===a&&(r.dataset.id?(s+=r.innerHTML,i.push(r.dataset.id)):r.outerHtml&&(s+=r.outerHtml))}};o(e);let n=s.trim();""!==n&&t.push({type:"text",content:n,atUserIds:i}),this.$emit("submit",t)},focus(){this.$refs.content.focus()}}},Oe=Be,Ue=(s("b575"),Object(d["a"])(Oe,Ae,Pe,!1,null,null,null)),Ge=Ue.exports,De={name:"chatPrivate",components:{ChatInput:Ge,ChatMessageItem:J,FileUpload:Y["a"],ChatGroupSide:C,Emotion:ee,ChatRecord:le,ChatHistory:pe,ChatAtBox:ye,GroupMemberSelector:$e},props:{chat:{type:Object}},data(){return{userInfo:{},group:{},groupMembers:[],sendImageUrl:"",sendImageFile:"",placeholder:"",isReceipt:!0,showRecord:!1,showSide:!1,showHistory:!1,lockMessage:!1,showMinIdx:0,reqQueue:[],isSending:!1}},methods:{moveChatToTop(){let e=this.$store.getters.findChatIdx(this.chat);this.$store.commit("moveTop",e)},closeRefBox(){this.$refs.emoBox.close()},onCall(e){e==this.$enums.MESSAGE_TYPE.ACT_RT_VOICE?this.showPrivateVideo("voice"):e==this.$enums.MESSAGE_TYPE.ACT_RT_VIDEO&&this.showPrivateVideo("video")},onSwitchReceipt(){this.isReceipt=!this.isReceipt,this.refreshPlaceHolder()},onImageSuccess(e,t){let s=JSON.parse(JSON.stringify(t.msgInfo));s.content=JSON.stringify(e),s.receipt=this.isReceipt,this.sendMessageRequest(s).then(e=>{s.loadStatus="ok",s.id=e.id,this.isReceipt=!1,this.$store.commit("insertMessage",[s,t.chat])})},onImageFail(e,t){let s=JSON.parse(JSON.stringify(t.msgInfo));s.loadStatus="fail",this.$store.commit("insertMessage",[s,t.chat])},onImageBefore(e){if(this.isBanned)return void this.showBannedTip();let t=URL.createObjectURL(e),s={originUrl:t,thumbUrl:t},i={id:0,tmpId:this.generateId(),fileId:e.uid,sendId:this.mine.id,content:JSON.stringify(s),sendTime:(new Date).getTime(),selfSend:!0,type:1,readedCount:0,loadStatus:"loading",status:this.$enums.MESSAGE_STATUS.UNSEND};this.fillTargetId(i,this.chat.targetId),this.$store.commit("insertMessage",[i,this.chat]),this.moveChatToTop(),this.scrollToBottom(),e.msgInfo=i,e.chat=this.chat},onFileSuccess(e,t){let s={name:t.name,size:t.size,url:e},i=JSON.parse(JSON.stringify(t.msgInfo));i.content=JSON.stringify(s),i.receipt=this.isReceipt,this.sendMessageRequest(i).then(e=>{i.loadStatus="ok",i.id=e.id,this.isReceipt=!1,this.refreshPlaceHolder(),this.$store.commit("insertMessage",[i,t.chat])})},onFileFail(e,t){let s=JSON.parse(JSON.stringify(t.msgInfo));s.loadStatus="fail",this.$store.commit("insertMessage",[s,t.chat])},onFileBefore(e){if(this.isBanned)return void this.showBannedTip();let t=URL.createObjectURL(e),s={name:e.name,size:e.size,url:t},i={id:0,tmpId:this.generateId(),sendId:this.mine.id,content:JSON.stringify(s),sendTime:(new Date).getTime(),selfSend:!0,type:2,loadStatus:"loading",readedCount:0,status:this.$enums.MESSAGE_STATUS.UNSEND};this.fillTargetId(i,this.chat.targetId),this.$store.commit("insertMessage",[i,this.chat]),this.moveChatToTop(),this.scrollToBottom(),e.msgInfo=i,e.chat=this.chat},onCloseSide(){this.showSide=!1},onScrollToTop(){this.showMinIdx=this.showMinIdx>10?this.showMinIdx-10:0},onScroll(e){let t=e.target,s=t.scrollTop;s<30&&(this.showMinIdx=this.showMinIdx>20?this.showMinIdx-20:0)},showEmotionBox(){let e=this.$refs.emotion.offsetWidth,t=this.$elm.fixLeft(this.$refs.emotion),s=this.$elm.fixTop(this.$refs.emotion);this.$refs.emoBox.open({x:t+e/2,y:s})},onEmotion(e){this.$refs.chatInputEditor.insertEmoji(e)},showRecordBox(){this.showRecord=!0},closeRecordBox(){this.showRecord=!1},showHistoryBox(){this.showHistory=!0},closeHistoryBox(){this.showHistory=!1},onSendRecord(e){if(this.isBanned)return void this.showBannedTip();let t={content:JSON.stringify(e),type:3,receipt:this.isReceipt};this.fillTargetId(t,this.chat.targetId),this.sendMessageRequest(t).then(e=>{e.selfSend=!0,this.$store.commit("insertMessage",[e,this.chat]),this.moveChatToTop(),this.$refs.chatInputEditor.focus(),this.scrollToBottom(),this.showRecord=!1,this.isReceipt=!1,this.refreshPlaceHolder()})},fillTargetId(e,t){"GROUP"==this.chat.type?e.groupId=t:e.recvId=t},notifySend(){this.$refs.chatInputEditor.submit()},async sendMessage(e){if(this.resetEditor(),this.readedMessage(),this.isBanned)return void this.showBannedTip();let t=this.isReceipt?"【回执消息】":"";for(let s=0;s<e.length;s++){let i=e[s];switch(i.type){case"text":await this.sendTextMessage(t+i.content,i.atUserIds);break;case"image":await this.sendImageMessage(i.content.file);break;case"file":await this.sendFileMessage(i.content.file);break}}},sendImageMessage(e){return new Promise((t,s)=>{this.onImageBefore(e);let i=new FormData;i.append("file",e),this.$http.post("/image/upload",i,{headers:{"Content-Type":"multipart/form-data"}}).then(s=>{this.onImageSuccess(s,e),t()}).catch(t=>{this.onImageFail(t,e),s()}),this.$nextTick(()=>this.$refs.chatInputEditor.focus()),this.scrollToBottom()})},sendTextMessage(e,t){return new Promise((s,i)=>{e.trim()||i();let o={content:e,type:0};this.fillTargetId(o,this.chat.targetId),"GROUP"==this.chat.type&&(o.atUserIds=t,o.receipt=this.isReceipt),this.lockMessage=!0,this.sendMessageRequest(o).then(e=>{e.selfSend=!0,this.$store.commit("insertMessage",[e,this.chat]),this.moveChatToTop()}).finally(()=>{this.scrollToBottom(),this.isReceipt=!1,s()})})},sendFileMessage(e){return new Promise((t,s)=>{let i=this.$refs.fileUpload.beforeUpload(e);i&&this.$refs.fileUpload.onFileUpload({file:e})})},deleteMessage(e){this.$confirm("确认删除消息?","删除消息",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("deleteMessage",e)})},recallMessage(e){this.$confirm("确认撤回消息?","撤回消息",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{let t=`/message/${this.chat.type.toLowerCase()}/recall/${e.id}`;this.$http({url:t,method:"delete"}).then(e=>{this.$message.success("消息已撤回"),e.selfSend=!0,this.$store.commit("recallMessage",[e,this.chat])})})},readedMessage(){if(0!=this.chat.unreadCount){if(this.$store.commit("resetUnreadCount",this.chat),"GROUP"==this.chat.type)var e="/message/group/readed?groupId="+this.chat.targetId;else e="/message/private/readed?friendId="+this.chat.targetId;this.$http({url:e,method:"put"}).then(()=>{})}},loadReaded(e){this.$http({url:"/message/private/maxReadedId?friendId="+e,method:"get"}).then(t=>{this.$store.commit("readedMessage",{friendId:e,maxId:t})})},loadGroup(e){this.$http({url:"/group/find/"+e,method:"get"}).then(e=>{this.group=e,this.$store.commit("updateChatFromGroup",e),this.$store.commit("updateGroup",e)}),this.$http({url:"/group/members/"+e,method:"get"}).then(e=>{this.groupMembers=e})},updateFriendInfo(){if(this.isFriend){let e=JSON.parse(JSON.stringify(this.friend));e.headImage=this.userInfo.headImageThumb,e.nickName=this.userInfo.nickName,e.showNickName=e.remarkNickName?e.remarkNickName:e.nickName,this.$store.commit("updateChatFromFriend",e),this.$store.commit("updateFriend",e)}else this.$store.commit("updateChatFromUser",this.userInfo)},loadFriend(e){this.$http({url:"/user/find/"+e,method:"GET"}).then(e=>{this.userInfo=e,this.updateFriendInfo()})},showName(e){if("GROUP"==this.chat.type){let t=this.groupMembers.find(t=>t.userId==e.sendId);return t?t.showNickName:""}return e.sendId==this.mine.id?this.mine.nickName:this.chat.showName},headImage(e){if("GROUP"==this.chat.type){let t=this.groupMembers.find(t=>t.userId==e.sendId);return t?t.headImage:""}return e.sendId==this.mine.id?this.mine.headImageThumb:this.chat.headImage},resetEditor(){this.$nextTick(()=>{this.$refs.chatInputEditor.clear(),this.$refs.chatInputEditor.focus()})},scrollToBottom(){this.$nextTick(()=>{let e=document.getElementById("chatScrollBox");e.scrollTop=e.scrollHeight})},refreshPlaceHolder(){this.isReceipt?this.placeholder="【回执消息】":this.$refs.editBox&&this.$refs.editBox.innerHTML?this.placeholder="":this.placeholder="聊点什么吧~"},sendMessageRequest(e){return new Promise((t,s)=>{this.reqQueue.push({msgInfo:e,resolve:t,reject:s}),this.processReqQueue()})},processReqQueue(){if(this.reqQueue.length&&!this.isSending){this.isSending=!0;const e=this.reqQueue.shift();this.$http({url:this.messageAction,method:"post",data:e.msgInfo}).then(t=>{e.resolve(t)}).catch(t=>{e.reject(t)}).finally(()=>{this.isSending=!1,this.processReqQueue()})}},showBannedTip(){let e={tmpId:this.generateId(),sendId:this.mine.id,sendTime:(new Date).getTime(),type:this.$enums.MESSAGE_TYPE.TIP_TEXT};"PRIVATE"==this.chat.type?(e.recvId=this.mine.id,e.content="该用户已被管理员封禁,原因:"+this.userInfo.reason):(e.groupId=this.group.id,e.content="本群聊已被管理员封禁,原因:"+this.group.reason),this.$store.commit("insertMessage",[e,this.chat])},generateId(){return String((new Date).getTime())+String(Math.floor(1e3*Math.random()))}},computed:{mine(){return this.$store.state.userStore.userInfo},isFriend(){return this.$store.getters.isFriend(this.userInfo.id)},friend(){return this.$store.getters.findFriend(this.userInfo.id)},title(){let e=this.chat.showName;if("GROUP"==this.chat.type){let t=this.groupMembers.filter(e=>!e.quit).length;e+=`(${t})`}return e},messageAction(){return`/message/${this.chat.type.toLowerCase()}/send`},unreadCount(){return this.chat.unreadCount},messageSize(){return this.chat&&this.chat.messages?this.chat.messages.length:0},isBanned(){return"PRIVATE"==this.chat.type&&this.userInfo.isBanned||"GROUP"==this.chat.type&&this.group.isBanned},memberSize(){return this.groupMembers.filter(e=>!e.quit).length}},watch:{chat:{handler(e,t){if(e.targetId>0&&(!t||e.type!=t.type||e.targetId!=t.targetId)){"GROUP"==this.chat.type?this.loadGroup(this.chat.targetId):(this.loadFriend(this.chat.targetId),this.loadReaded(this.chat.targetId)),this.scrollToBottom(),this.showSide=!1,this.readedMessage();let e=this.chat.messages.length;this.showMinIdx=e>30?e-30:0,this.resetEditor(),this.isReceipt=!1,this.refreshPlaceHolder()}},immediate:!0},messageSize:{handler(e,t){e>t&&this.scrollToBottom()}}},mounted(){let e=document.getElementById("chatScrollBox");e.addEventListener("scroll",this.onScroll)}},Le=De,Fe=(s("ee52"),Object(d["a"])(Le,p,f,!1,null,null,null)),je=Fe.exports,ze={name:"chat",components:{ChatItem:m,ChatBox:je},data(){return{searchText:"",messageContent:"",group:{},groupMembers:[]}},methods:{onActiveItem(e){this.$store.commit("activeChat",e)},onDelItem(e){this.$store.commit("removeChat",e)},onTop(e){this.$store.commit("moveTop",e)}},computed:{chatStore(){return this.$store.state.chatStore},loading(){return this.chatStore.loadingGroupMsg||this.chatStore.loadingPrivateMsg}}},He=ze,qe=(s("5a04"),Object(d["a"])(He,i,o,!1,null,null,null));t["default"]=qe.exports},"44b0":function(e,t,s){},5494:function(e,t,s){"use strict";var i=s("83ab"),o=s("e330"),n=s("edd0"),r=URLSearchParams.prototype,a=o(r.forEach);i&&!("size"in r)&&n(r,"size",{get:function(){var e=0;return a(this,(function(){e++})),e},configurable:!0,enumerable:!0})},"56f0":function(e,t,s){},"5a04":function(e,t,s){"use strict";s("b9fb")},"5b4c":function(e,t,s){"use strict";s("8d26")},"5bbc":function(e,t,s){},"5d98":function(e,t,s){"use strict";s("44b0")},7130:function(e,t,s){},"7baa":function(e,t,s){"use strict";s("7130")},"7cdc":function(e,t,s){},"7f1e":function(e,t,s){},8097:function(e,t,s){},8617:function(e,t,s){"use strict";s("7cdc")},8697:function(e,t,s){"use strict";s("9800")},"878a":function(e,t,s){"use strict";s("e1e3")},8822:function(e,t,s){"use strict";s("b194")},"88a7":function(e,t,s){"use strict";var i=s("cb2d"),o=s("e330"),n=s("577e"),r=s("d6d6"),a=URLSearchParams,l=a.prototype,c=o(l.append),h=o(l["delete"]),d=o(l.forEach),u=o([].push),m=new a("a=1&a=2&b=3");m["delete"]("a",1),m["delete"]("b",void 0),m+""!=="a=2"&&i(l,"delete",(function(e){var t=arguments.length,s=t<2?void 0:arguments[1];if(t&&void 0===s)return h(this,e);var i=[];d(this,(function(e,t){u(i,{key:t,value:e})})),r(t,1);var o,a=n(e),l=n(s),m=0,p=0,f=!1,g=i.length;while(m<g)o=i[m++],f||o.key===a?(f=!0,h(this,o.key)):p++;while(p<g)o=i[p++],o.key===a&&o.value===l||c(this,o.key,o.value)}),{enumerable:!0,unsafe:!0})},"8d26":function(e,t,s){},"930e":function(e,t,s){},9800:function(e,t,s){},a721:function(e,t,s){},a834:function(e,t,s){},a9d3:function(e,t,s){"use strict";s("8097")},aa5b:function(e,t,s){"use strict";s("a721")},ad9a:function(e,t,s){
/*!
 * 
 * js-audio-recorder - js audio recorder plugin
 * 
 * @version v1.0.7
 * @homepage https://github.com/2fps/recorder
 * @author 2fps <echoweb@126.com> (https://www.zhuyuntao.cn)
 * @license MIT
 *         
 */
!function(t,s){e.exports=s()}(0,(function(){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){"use strict";function i(e,t,s){for(var i=0;i<s.length;i++)e.setUint8(t+i,s.charCodeAt(i))}Object.defineProperty(t,"__esModule",{value:!0}),t.compress=function(e,t,s){for(var i=t/s,o=Math.max(i,1),n=e.left,r=e.right,a=Math.floor((n.length+r.length)/i),l=new Float32Array(a),c=0,h=0;c<a;){var d=Math.floor(h);l[c]=n[d],c++,r.length&&(l[c]=r[d],c++),h+=o}return l},t.encodePCM=function(e,t,s){void 0===s&&(s=!0);var i=0,o=e.length*(t/8),n=new ArrayBuffer(o),r=new DataView(n);if(8===t)for(var a=0;a<e.length;a++,i++){var l=(c=Math.max(-1,Math.min(1,e[a])))<0?128*c:127*c;l=+l+128,r.setInt8(i,l)}else for(a=0;a<e.length;a++,i+=2){var c=Math.max(-1,Math.min(1,e[a]));r.setInt16(i,c<0?32768*c:32767*c,s)}return r},t.encodeWAV=function(e,t,s,o,n,r){void 0===r&&(r=!0);var a=s>t?t:s,l=n,c=new ArrayBuffer(44+e.byteLength),h=new DataView(c),d=o,u=0;i(h,u,"RIFF"),u+=4,h.setUint32(u,36+e.byteLength,r),i(h,u+=4,"WAVE"),i(h,u+=4,"fmt "),u+=4,h.setUint32(u,16,r),u+=4,h.setUint16(u,1,r),u+=2,h.setUint16(u,d,r),u+=2,h.setUint32(u,a,r),u+=4,h.setUint32(u,d*a*(l/8),r),u+=4,h.setUint16(u,d*(l/8),r),u+=2,h.setUint16(u,l,r),i(h,u+=2,"data"),u+=4,h.setUint32(u,e.byteLength,r),u+=4;for(var m=0;m<e.byteLength;)h.setUint8(u,e.getUint8(m)),u++,m++;return h}},function(e,t,s){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var n=s(2),r=s(0),a=s(3),l=function(e){function t(t){void 0===t&&(t={});var s=e.call(this,t)||this;return s.isrecording=!1,s.ispause=!1,s.isplaying=!1,s}return o(t,e),t.prototype.setOption=function(e){void 0===e&&(e={}),this.setNewOption(e)},t.prototype.start=function(){return this.isrecording?Promise.reject():(this.isrecording=!0,this.startRecord())},t.prototype.pause=function(){this.isrecording&&!this.ispause&&(this.ispause=!0,this.pauseRecord())},t.prototype.resume=function(){this.isrecording&&this.ispause&&(this.ispause=!1,this.resumeRecord())},t.prototype.stop=function(){this.isrecording&&(this.isrecording=!1,this.ispause=!1,this.stopRecord())},t.prototype.play=function(){this.stop(),this.isplaying=!0,this.onplay&&this.onplay(),a.default.addPlayEnd(this.onplayend);var e=this.getWAV();e.byteLength>44&&a.default.play(e.buffer)},t.prototype.getPlayTime=function(){return a.default.getPlayTime()},t.prototype.pausePlay=function(){!this.isrecording&&this.isplaying&&(this.isplaying=!1,this.onpauseplay&&this.onpauseplay(),a.default.pausePlay())},t.prototype.resumePlay=function(){this.isrecording||this.isplaying||(this.isplaying=!0,this.onresumeplay&&this.onresumeplay(),a.default.resumePlay())},t.prototype.stopPlay=function(){this.isrecording||(this.isplaying=!1,this.onstopplay&&this.onstopplay(),a.default.stopPlay())},t.prototype.destroy=function(){return a.default.destroyPlay(),this.destroyRecord()},t.prototype.getRecordAnalyseData=function(){return this.getAnalyseData()},t.prototype.getPlayAnalyseData=function(){return a.default.getAnalyseData()},t.prototype.getPCM=function(){this.stop();var e=this.getData();return e=r.compress(e,this.inputSampleRate,this.outputSampleRate),r.encodePCM(e,this.oututSampleBits,this.littleEdian)},t.prototype.getPCMBlob=function(){return new Blob([this.getPCM()])},t.prototype.downloadPCM=function(e){void 0===e&&(e="recorder");var t=this.getPCMBlob();n.downloadPCM(t,e)},t.prototype.getWAV=function(){var e=this.getPCM();return r.encodeWAV(e,this.inputSampleRate,this.outputSampleRate,this.config.numChannels,this.oututSampleBits,this.littleEdian)},t.prototype.getWAVBlob=function(){return new Blob([this.getWAV()],{type:"audio/wav"})},t.prototype.downloadWAV=function(e){void 0===e&&(e="recorder");var t=this.getWAVBlob();n.downloadWAV(t,e)},t.prototype.download=function(e,t,s){n.download(e,t,s)},t.prototype.getChannelData=function(){var e=this.getPCM(),t=e.byteLength,s=this.littleEdian,i={left:null,right:null};if(2===this.config.numChannels){var o=new DataView(new ArrayBuffer(t/2)),n=new DataView(new ArrayBuffer(t/2));if(16===this.config.sampleBits)for(var r=0;r<t/2;r+=2)o.setInt16(r,e.getInt16(2*r,s),s),n.setInt16(r,e.getInt16(2*r+2,s),s);else for(r=0;r<t/2;r+=2)o.setInt8(r,e.getInt8(2*r)),n.setInt8(r,e.getInt8(2*r+1));i.left=o,i.right=n}else i.left=e;return i},t}(s(5).default);t.default=l},function(e,t,s){"use strict";function i(e,t,s){var i=document.createElement("a");i.href=window.URL.createObjectURL(e),i.download=t+"."+s,i.click()}Object.defineProperty(t,"__esModule",{value:!0}),t.downloadWAV=function(e,t){void 0===t&&(t="recorder"),i(e,t,"wav")},t.downloadPCM=function(e,t){void 0===t&&(t="recorder"),i(e,t,"pcm")},t.download=function(e,t,s){return i(e,t,s)}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s(4),o=null,n=0,r=0,a=null,l=null,c=null,h=!1,d=0,u=function(){};function m(){return h=!1,a.decodeAudioData(c.slice(0),(function(e){(o=a.createBufferSource()).onended=function(){h||(d=a.currentTime-r+n,u())},o.buffer=e,o.connect(l),l.connect(a.destination),o.start(0,n),r=a.currentTime}),(function(e){i.throwError(e)}))}function p(){o&&(o.stop(),o=null)}var f=function(){function e(){}return e.play=function(e){return a||(a=new(window.AudioContext||window.webkitAudioContext),(l=a.createAnalyser()).fftSize=2048),this.stopPlay(),c=e,d=0,m()},e.pausePlay=function(){p(),n+=a.currentTime-r,h=!0},e.resumePlay=function(){return m()},e.stopPlay=function(){n=0,c=null,p()},e.destroyPlay=function(){this.stopPlay()},e.getAnalyseData=function(){var e=new Uint8Array(l.frequencyBinCount);return l.getByteTimeDomainData(e),e},e.addPlayEnd=function(e){void 0===e&&(e=function(){}),u=e},e.getPlayTime=function(){var e=h?n:a.currentTime-r+n;return d||e},e}();t.default=f},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throwError=function(e){throw new Error(e)}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s(0),o=function(){function e(t){void 0===t&&(t={}),this.size=0,this.lBuffer=[],this.rBuffer=[],this.tempPCM=[],this.inputSampleBits=16,this.fileSize=0,this.duration=0,this.needRecord=!0;var s,i=new(window.AudioContext||window.webkitAudioContext);this.inputSampleRate=i.sampleRate,this.setNewOption(t),this.littleEdian=(s=new ArrayBuffer(2),new DataView(s).setInt16(0,256,!0),256===new Int16Array(s)[0]),e.initUserMedia()}return e.prototype.setNewOption=function(e){void 0===e&&(e={}),this.config={sampleBits:~[8,16].indexOf(e.sampleBits)?e.sampleBits:16,sampleRate:~[8e3,11025,16e3,22050,24e3,44100,48e3].indexOf(e.sampleRate)?e.sampleRate:this.inputSampleRate,numChannels:~[1,2].indexOf(e.numChannels)?e.numChannels:1},this.outputSampleRate=this.config.sampleRate,this.oututSampleBits=this.config.sampleBits},e.prototype.startRecord=function(){var e=this;return this.context&&this.destroyRecord(),this.initRecorder(),navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){e.audioInput=e.context.createMediaStreamSource(t),e.stream=t})).then((function(){e.audioInput.connect(e.analyser),e.analyser.connect(e.recorder),e.recorder.connect(e.context.destination)}))},e.prototype.pauseRecord=function(){this.needRecord=!1},e.prototype.resumeRecord=function(){this.needRecord=!0},e.prototype.stopRecord=function(){this.audioInput&&this.audioInput.disconnect(),this.source&&this.source.stop(),this.recorder.disconnect(),this.analyser.disconnect(),this.needRecord=!0},e.prototype.destroyRecord=function(){return this.clearRecordStatus(),this.stopStream(),this.closeAudioContext()},e.prototype.getAnalyseData=function(){var e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(e),e},e.prototype.getData=function(){return this.flat()},e.prototype.clearRecordStatus=function(){this.lBuffer.length=0,this.rBuffer.length=0,this.size=0,this.fileSize=0,this.PCM=null,this.audioInput=null,this.duration=0},e.prototype.flat=function(){var e=null,t=new Float32Array(0);1===this.config.numChannels?e=new Float32Array(this.size):(e=new Float32Array(this.size/2),t=new Float32Array(this.size/2));for(var s=0,i=0;i<this.lBuffer.length;i++)e.set(this.lBuffer[i],s),s+=this.lBuffer[i].length;for(s=0,i=0;i<this.rBuffer.length;i++)t.set(this.rBuffer[i],s),s+=this.rBuffer[i].length;return{left:e,right:t}},e.prototype.initRecorder=function(){var e=this;this.clearRecordStatus(),this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048;var t=this.context.createScriptProcessor||this.context.createJavaScriptNode;this.recorder=t.apply(this.context,[4096,this.config.numChannels,this.config.numChannels]),this.recorder.onaudioprocess=function(t){if(e.needRecord){var s,i=t.inputBuffer.getChannelData(0),o=null;e.lBuffer.push(new Float32Array(i)),e.size+=i.length,2===e.config.numChannels&&(o=t.inputBuffer.getChannelData(1),e.rBuffer.push(new Float32Array(o)),e.size+=o.length),e.fileSize=Math.floor(e.size/Math.max(e.inputSampleRate/e.outputSampleRate,1))*(e.oututSampleBits/8),s=100*Math.max.apply(Math,i),e.duration+=4096/e.inputSampleRate,e.onprocess&&e.onprocess(e.duration),e.onprogress&&e.onprogress({duration:e.duration,fileSize:e.fileSize,vol:s})}}},e.prototype.stopStream=function(){this.stream&&this.stream.getTracks&&(this.stream.getTracks().forEach((function(e){return e.stop()})),this.stream=null)},e.prototype.closeAudioContext=function(){return this.context&&this.context.close&&"closed"!==this.context.state?this.context.close():new Promise((function(e){e()}))},e.initUserMedia=function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(s,i){t.call(navigator,e,s,i)})):Promise.reject(new Error("浏览器不支持 getUserMedia !"))})},e.prototype.transformIntoPCM=function(e,t){var s=new Float32Array(e),o=new Float32Array(t),n=i.compress({left:s,right:o},this.inputSampleRate,this.outputSampleRate);return i.encodePCM(n,this.oututSampleBits,this.littleEdian)},e.getPermission=function(){return this.initUserMedia(),navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){e&&e.getTracks().forEach((function(e){return e.stop()}))}))},e}();t.default=o}]).default}))},b194:function(e,t,s){},b242:function(e,t,s){"use strict";var i=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{title:"邀请好友",visible:e.visible,width:"620px","before-close":e.onClose},on:{"update:visible":function(t){e.visible=t}}},[t("div",{staticClass:"agm-container"},[t("div",{staticClass:"agm-l-box"},[t("div",{staticClass:"search"},[t("el-input",{attrs:{placeholder:"搜索好友",size:"small"},model:{value:e.searchText,callback:function(t){e.searchText=t},expression:"searchText"}},[t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"suffix"},slot:"suffix"})])],1),t("el-scrollbar",{staticStyle:{height:"400px"}},e._l(e.friends,(function(s){return t("div",{key:s.id},[t("friend-item",{directives:[{name:"show",rawName:"v-show",value:s.nickName.includes(e.searchText),expression:"friend.nickName.includes(searchText)"}],attrs:{showDelete:!1,menu:!1,friend:s,active:!1},nativeOn:{click:function(t){return e.onSwitchCheck(s)}}},[t("el-checkbox",{staticClass:"agm-friend-checkbox",attrs:{disabled:s.disabled,size:"medium"},nativeOn:{click:function(e){e.stopPropagation()}},model:{value:s.isCheck,callback:function(t){e.$set(s,"isCheck",t)},expression:"friend.isCheck"}})],1)],1)})),0)],1),t("div",{staticClass:"agm-arrow el-icon-d-arrow-right"}),t("div",{staticClass:"agm-r-box"},[t("div",{staticClass:"agm-select-tip"},[e._v(" 已勾选"+e._s(e.checkCount)+"位好友")]),t("el-scrollbar",{staticStyle:{height:"400px"}},e._l(e.friends,(function(s){return t("div",{key:s.id},[s.isCheck&&!s.disabled?t("friend-item",{attrs:{friend:s,active:!1,menu:!1},on:{del:function(t){return e.onRemoveFriend(s)}}}):e._e()],1)})),0)],1)]),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){return e.onClose()}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.onOk()}}},[e._v("确 定")])],1)])},o=[],n=(s("14d9"),s("0643"),s("2382"),s("fffc"),s("4e3e"),s("ff36")),r={name:"addGroupMember",components:{FriendItem:n["a"]},data(){return{searchText:"",friends:[]}},methods:{onClose(){this.$emit("close")},onOk(){let e={groupId:this.groupId,friendIds:[]};this.friends.forEach(t=>{t.isCheck&&!t.disabled&&e.friendIds.push(t.id)}),e.friendIds.length>0&&this.$http({url:"/group/invite",method:"post",data:e}).then(()=>{this.$message.success("邀请成功"),this.$emit("reload"),this.$emit("close")})},onRemoveFriend(e){e.isCheck=!1},onSwitchCheck(e){e.disabled||(e.isCheck=!e.isCheck)}},props:{visible:{type:Boolean},groupId:{type:Number},members:{type:Array}},computed:{checkCount(){return this.friends.filter(e=>e.isCheck&&!e.disabled).length}},watch:{visible:function(e,t){e&&(this.friends=[],this.$store.state.friendStore.friends.forEach(e=>{if(e.deleted)return;let t=JSON.parse(JSON.stringify(e)),s=this.members.filter(e=>!e.quit).find(t=>t.userId==e.id);s?(t.disabled=!0,t.isCheck=!0):(t.disabled=!1,t.isCheck=!1),this.friends.push(t)}))}}},a=r,l=(s("d592"),s("2877")),c=Object(l["a"])(a,i,o,!1,null,null,null);t["a"]=c.exports},b575:function(e,t,s){"use strict";s("7f1e")},b83e:function(e,t,s){},b9fb:function(e,t,s){},bfba:function(e,t,s){"use strict";s("930e")},d4e3:function(e,t,s){},d592:function(e,t,s){"use strict";s("ee6a")},d6d6:function(e,t,s){"use strict";var i=TypeError;e.exports=function(e,t){if(e<t)throw new i("Not enough arguments");return e}},da12:function(e,t,s){"use strict";s("56f0")},da43:function(e,t,s){e.exports=s("ad9a")},dee0:function(e,t,s){"use strict";s("5bbc")},e1e3:function(e,t,s){},ee52:function(e,t,s){"use strict";s("b83e")},ee6a:function(e,t,s){},ff36:function(e,t,s){"use strict";var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"friend-item",class:e.active?"active":"",on:{contextmenu:function(t){return t.preventDefault(),e.showRightMenu(t)}}},[t("div",{staticClass:"friend-avatar"},[t("head-image",{attrs:{size:42,name:e.friend.nickName,url:e.friend.headImage,online:e.friend.online}})],1),t("div",{staticClass:"friend-info"},[t("div",{staticClass:"friend-name"},[e._v(e._s(e.friend.nickName))]),t("div",{staticClass:"friend-online"},[t("i",{directives:[{name:"show",rawName:"v-show",value:e.friend.onlineWeb,expression:"friend.onlineWeb"}],staticClass:"el-icon-monitor online",attrs:{title:"电脑设备在线"}},[t("span",{staticClass:"online-icon"})]),t("i",{directives:[{name:"show",rawName:"v-show",value:e.friend.onlineApp,expression:"friend.onlineApp"}],staticClass:"el-icon-mobile-phone online",attrs:{title:"移动设备在线"}},[t("span",{staticClass:"online-icon"})])])]),t("right-menu",{directives:[{name:"show",rawName:"v-show",value:e.menu&&e.rightMenu.show,expression:"menu && rightMenu.show"}],attrs:{pos:e.rightMenu.pos,items:e.rightMenu.items},on:{close:function(t){e.rightMenu.show=!1},select:e.onSelectMenu}}),e._t("default")],2)},o=[],n=s("4036"),r=s("3f51"),a={name:"frinedItem",components:{HeadImage:n["a"],RightMenu:r["a"]},data(){return{rightMenu:{show:!1,pos:{x:0,y:0},items:[{key:"CHAT",name:"发送消息",icon:"el-icon-chat-dot-round"},{key:"DELETE",name:"删除好友",icon:"el-icon-delete"}]}}},methods:{showRightMenu(e){this.rightMenu.pos={x:e.x,y:e.y},this.rightMenu.show="true"},onSelectMenu(e){this.$emit(e.key.toLowerCase(),this.msgInfo)}},props:{active:{type:Boolean},friend:{type:Object},menu:{type:Boolean,default:!0}}},l=a,c=(s("5d98"),s("2877")),h=Object(c["a"])(l,i,o,!1,null,null,null);t["a"]=h.exports}}]);
//# sourceMappingURL=chunk-3b5de258.ae6e1142.js.map